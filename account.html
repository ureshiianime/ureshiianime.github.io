<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://apis.google.com https://accounts.google.com https://www.gstatic.com https://ssl.gstatic.com https://www.googleapis.com https://cdnjs.cloudflare.com blob: data:; frame-src 'self' https://accounts.google.com https://content.googleapis.com; connect-src 'self' https://accounts.google.com https://www.googleapis.com https://oauth2.googleapis.com https://content.googleapis.com;">
    <title>Mi Cuenta - Ureshii Anime</title>
    <link rel="stylesheet" href="css/index.css">
    <link rel="icon" href="img/logo.png" type="image/x-icon">
    <link rel="apple-touch-icon" href="img/logo.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ureshii Anime">
    <script src="glob/localstorage.js"></script>
    <script src="glob/google-drive.js"></script>
    <script src="animes.js"></script>
    <script src="glob/header.js"></script>
    <link rel="stylesheet" href="glob/header.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/account.css">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

</head>
<body>
    <header>
        <div class="menu-button" id="menu-toggle">
            <svg class="menu-ab-svg--wDGx3 header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="menu-svg" aria-hidden="true" role="img"><path class="menu-ab-svg__top--Xgjtj" d="M20 5H4V7H20V5Z"></path><path class="menu-ab-svg__middle--vsB5D" d="M4 11H20V13H4V11Z"></path><path class="menu-ab-svg__bottom--6yklx" d="M20 17H4V19H20V17Z"></path></svg>
        </div>
        <a href="index.html" class="header-logo">
            <picture>
                <source media="(max-width: 768px)" srcset="img/logo.png">
                <source media="(min-width: 769px)" srcset="img/horizontal-logo.png">
                <img src="img/horizontal-logo.png" alt="Ureshii Anime" class="logo-img">
            </picture>
        </a>
        <div class="nav-categories">
            <a href="index.html" class="nav-category">Catálogo</a>
            <a href="novedades.html" class="nav-category">Novedades</a>
        </div>
        <div class="header-buttons">
            <a href="search.html" class="header-button">
                <svg class="header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="search-svg" aria-hidden="true" role="img"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5 19C12.4879 19 14.3164 18.3176 15.7641 17.1742L21.2927 22.7069L22.7074 21.2931L17.1778 15.7595C18.319 14.3126 19 12.4858 19 10.5C19 5.80558 15.1944 2 10.5 2C5.80558 2 2 5.80558 2 10.5C2 15.1944 5.80558 19 10.5 19ZM10.5 17C14.0899 17 17 14.0899 17 10.5C17 6.91015 14.0899 4 10.5 4C6.91015 4 4 6.91015 4 10.5C4 14.0899 6.91015 17 10.5 17Z"></path></svg>
            </a>
            <a href="ureshiilists.html" class="header-button">
                <svg class="header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="watchlist-svg" aria-hidden="true" role="img"><path fill-rule="evenodd" clip-rule="evenodd" d="M19.0001 20.5858C19.0001 21.4767 17.9229 21.9229 17.293 21.2929L12.0001 16L6.7071 21.2929C6.07714 21.9229 5 21.4767 5 20.5858L5.00006 3H19.0001V20.5858ZM7.00001 18.1716L7.00006 5H17.0001V18.1716L12.0001 13.1716L7.00001 18.1716Z"></path></svg>
            </a>
            <a href="account.html" class="export-button" id="export-import-button">
                <svg class="header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="user-settings-svg" aria-hidden="true" role="img"><path d="M12 20a6.01 6.01 0 0 1-5.966-5.355L12 12.088l5.966 2.557A6.01 6.01 0 0 1 12 20m0-16c1.654 0 3 1.346 3 3s-1.345 3-2.999 3h-.002A3.003 3.003 0 0 1 9 7c0-1.654 1.346-3 3-3m7.394 9.081l-4.572-1.959A4.997 4.997 0 0 0 17 7c0-2.757-2.243-5-5-5S7 4.243 7 7c0 1.71.865 3.22 2.178 4.122l-4.572 1.959A.999.999 0 0 0 4 14c0 4.411 3.589 8 8 8s8-3.589 8-8c0-.4-.238-.762-.606-.919"></path></svg>
            </a>
        </div>
    </header>

    <div class="account-container">
        <h1 class="section-title">Mi Cuenta</h1>
        
        <!-- Modal de confirmación -->
        <div id="confirmation-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-exclamation-triangle"></i> Confirmación</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <p>Al cargar este token se eliminarán todos los datos actuales y se cargarán los nuevos datos.</p>
                    <p>¿Estás seguro de que deseas continuar?</p>
                </div>
                <div class="modal-footer">
                    <button id="cancel-import" class="btn btn-secondary">Cancelar</button>
                    <button id="confirm-import" class="btn btn-primary">Confirmar</button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <i class="fas fa-sync-alt"></i>
                <h2>Gestión de Datos</h2>
            </div>
            <div class="card-body">
                
                <div class="section-card">
                    <h3><i class="fab fa-google-drive"></i> Google Drive</h3>
                    <p>Gestiona tus datos en Google Drive de forma manual.</p>
                    
                    <div class="drive-buttons">
                        <button id="signin-button" class="btn btn-google"><i class="fab fa-google"></i> Iniciar sesión</button>
                        <button id="load-button" class="btn btn-primary" style="display:none;"><i class="fas fa-download"></i> Cargar</button>
                        <button id="save-button" class="btn btn-success" style="display:none;"><i class="fas fa-upload"></i> Guardar</button>
                        <button id="signout-button" class="btn btn-secondary" style="display:none;"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</button>
                    </div>
                    <div id="drive-result" class="alert"></div>
                </div>
                
                <div class="section-card">
                    <h3><i class="fas fa-file-export"></i> Exportar Datos</h3>
                    <p>Genera un código para guardar tus datos y poder recuperarlos más tarde.</p>
                    <button id="generate-export-code" class="btn">Generar Código</button>
                    <div id="export-code-container" style="display: none;">
                        <textarea id="export-code" class="form-control" rows="4" readonly></textarea>
                        <button id="copy-export-code" class="btn">Copiar Código</button>
                    </div>
                </div>
                
                
                <div class="section-card">
                    <h3><i class="fas fa-file-import"></i> Importar Datos</h3>
                    <p>Pega tu código para recuperar tus datos guardados anteriormente.</p>
                    <textarea id="import-code" class="form-control" rows="4" placeholder="Pega aquí tu código..."></textarea>
                    <button id="import-data-button" class="btn">Importar Datos</button>
                    <div id="import-result" class="alert"></div>
                </div>
            </div>
        </div>
        
        
        <div class="privacy-notice">
            <h4><i class="fas fa-shield-alt"></i> Información sobre el manejo de datos</h4>
            <p>Todos los datos sincronizados con Google Drive son gestionados directamente por Google y no pasan por nuestros servidores. Ureshii Anime no tiene acceso a tus credenciales ni a la información almacenada en tu cuenta de Google.</p>
            <p>Al utilizar la sincronización con Google Drive, aceptas los términos y condiciones de Google. Tus datos se almacenan únicamente en tu cuenta personal y solo tú tienes control sobre ellos.</p>
            <p>La exportación manual genera un código que puedes guardar donde prefieras. Este código contiene tus listas y progreso, pero no incluye información personal identificable.</p>
        </div>
    </div>
    
    <script>
        
        document.addEventListener('DOMContentLoaded', function() {
            
            let watchedEpisodes = JSON.parse(localStorage.getItem(window.WATCHED_EPISODES_KEY)) || {};
            let myList = JSON.parse(localStorage.getItem(window.MY_LIST_KEY)) || [];
            let watchingAnimes = JSON.parse(localStorage.getItem(window.WATCHING_ANIMES_KEY)) || [];
            let favorites = JSON.parse(localStorage.getItem(window.FAVORITES_KEY)) || [];
            let ureshiiLists = JSON.parse(localStorage.getItem(window.URESHII_LISTS_KEY)) || {};

        const generateExportCode = document.getElementById('generate-export-code');
        const exportCodeContainer = document.getElementById('export-code-container');
        const exportCode = document.getElementById('export-code');
        const copyExportCode = document.getElementById('copy-export-code');
        const importCode = document.getElementById('import-code');
        const importDataButton = document.getElementById('import-data-button');
        const importResult = document.getElementById('import-result');

        generateExportCode.addEventListener('click', () => {
            const userData = { watchedEpisodes, myList, watchingAnimes, favorites, ureshiiLists };
            exportCode.value = btoa(JSON.stringify(userData));
            exportCodeContainer.style.display = 'block';
        });

        copyExportCode.addEventListener('click', () => {
            exportCode.select();
            document.execCommand('copy');
            const originalText = copyExportCode.textContent;
            copyExportCode.textContent = '¡Copiado!';
            setTimeout(() => copyExportCode.textContent = originalText, 2000);
        });

        // Modal de confirmación
        const modal = document.getElementById('confirmation-modal');
        const closeBtn = document.querySelector('.close');
        const cancelImport = document.getElementById('cancel-import');
        const confirmImport = document.getElementById('confirm-import');
        let currentEncodedData = '';
        
        // Función para abrir el modal
        function openModal() {
            modal.style.display = 'block';
            document.body.classList.add('modal-open');
        }
        
        // Función para cerrar el modal
        function closeModal() {
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
        }
        
        // Cerrar modal
        closeBtn.addEventListener('click', closeModal);
        
        cancelImport.addEventListener('click', closeModal);
        
        // Cuando se hace clic fuera del modal
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal();
            }
        });
        
        // Función para importar datos
        function importUserData(encodedData) {
            try {
                if (!encodedData) throw new Error('Por favor, introduce un código válido');
                const userData = JSON.parse(atob(encodedData));
                if (!userData.watchedEpisodes || !userData.myList || !userData.watchingAnimes) {
                    throw new Error('El código no contiene datos válidos');
                }
                
                // Eliminar todos los datos actuales
                localStorage.removeItem(window.WATCHED_EPISODES_KEY);
                localStorage.removeItem(window.MY_LIST_KEY);
                localStorage.removeItem(window.WATCHING_ANIMES_KEY);
                localStorage.removeItem(window.FAVORITES_KEY);
                localStorage.removeItem(window.URESHII_LISTS_KEY);
                
                // Cargar los nuevos datos
                watchedEpisodes = userData.watchedEpisodes;
                myList = userData.myList;
                watchingAnimes = userData.watchingAnimes;
                favorites = userData.favorites || [];
                ureshiiLists = userData.ureshiiLists || {};
                
                localStorage.setItem(window.WATCHED_EPISODES_KEY, JSON.stringify(watchedEpisodes));
                localStorage.setItem(window.MY_LIST_KEY, JSON.stringify(myList));
                localStorage.setItem(window.WATCHING_ANIMES_KEY, JSON.stringify(watchingAnimes));
                localStorage.setItem(window.FAVORITES_KEY, JSON.stringify(favorites));
                localStorage.setItem(window.URESHII_LISTS_KEY, JSON.stringify(ureshiiLists));
                
                importResult.textContent = '¡Datos importados correctamente!';
                importResult.className = 'alert alert-success';
                importCode.value = '';
            } catch (e) {
                importResult.textContent = `Error: ${e.message}`;
                importResult.className = 'alert alert-error';
            }
        }
        
        // Mostrar modal de confirmación al hacer clic en importar
        importDataButton.addEventListener('click', () => {
            currentEncodedData = importCode.value.trim();
            if (!currentEncodedData) {
                importResult.textContent = 'Error: Por favor, introduce un código válido';
                importResult.className = 'alert alert-error';
                return;
            }
            
            try {
                // Verificar que el código es válido antes de mostrar el modal
                const testData = JSON.parse(atob(currentEncodedData));
                if (!testData.watchedEpisodes || !testData.myList || !testData.watchingAnimes) {
                    throw new Error('El código no contiene datos válidos');
                }
                
                // Mostrar el modal de confirmación
                openModal();
            } catch (e) {
                importResult.textContent = `Error: ${e.message}`;
                importResult.className = 'alert alert-error';
            }
        });
        
        // Confirmar importación
        confirmImport.addEventListener('click', () => {
            closeModal();
            importUserData(currentEncodedData);
        });

        
        const signinButton = document.getElementById('signin-button');
        const loadButton = document.getElementById('load-button');
        const saveButton = document.getElementById('save-button');
        const signoutButton = document.getElementById('signout-button');
        const driveResult = document.getElementById('drive-result');

        signinButton.onclick = async () => {
            if (window.googleDrive && window.googleDrive.signIn) {
                try {
                    driveResult.textContent = "⏳ Iniciando sesión...";
                    driveResult.className = "alert alert-info";
                    
                    await window.googleDrive.signIn();
                    
                    signinButton.style.display = "none";
                    loadButton.style.display = "inline-block";
                    saveButton.style.display = "inline-block";
                    signoutButton.style.display = "inline-block";
                    driveResult.textContent = "✅ Conectado con Google Drive";
                    driveResult.className = "alert alert-success";
                } catch (error) {
                    driveResult.textContent = "❌ Error al iniciar sesión: " + error.message;
                    driveResult.className = "alert alert-error";
                }
            } else {
                driveResult.textContent = "❌ Sistema de Google Drive no disponible";
                driveResult.className = "alert alert-error";
            }
        };
        
        loadButton.onclick = async () => {
            // Mostrar modal de confirmación para cargar desde Drive
            openModal();
            
            // Cambiar el texto del modal para la carga desde Drive
            document.querySelector('.modal-body').innerHTML = `
                <p>Al cargar los datos desde Google Drive se eliminarán todos los datos actuales y se cargarán los nuevos datos.</p>
                <p>¿Estás seguro de que deseas continuar?</p>
            `;
            
            // Cambiar la función del botón confirmar para cargar desde Drive
            const originalConfirmAction = confirmImport.onclick;
            confirmImport.onclick = async () => {
                closeModal();
                if (window.manualLoadFromDrive) {
                    try {
                        // Eliminar todos los datos actuales
                        localStorage.removeItem(window.WATCHED_EPISODES_KEY);
                        localStorage.removeItem(window.MY_LIST_KEY);
                        localStorage.removeItem(window.WATCHING_ANIMES_KEY);
                        localStorage.removeItem(window.FAVORITES_KEY);
                        localStorage.removeItem(window.URESHII_LISTS_KEY);
                        
                        driveResult.textContent = "⏳ Cargando datos...";
                        driveResult.className = "alert alert-info";
                        await window.manualLoadFromDrive();
                        driveResult.textContent = "✅ Datos cargados desde Google Drive";
                        driveResult.className = "alert alert-success";
                        
                        setTimeout(() => location.reload(), 1000);
                    } catch (error) {
                        driveResult.textContent = "❌ Error al cargar: " + error.message;
                        driveResult.className = "alert alert-error";
                    }
                }
                // Restaurar la función original del botón confirmar
                confirmImport.onclick = originalConfirmAction;
            };
            
            // Cambiar la función del botón cancelar
            const originalCancelAction = cancelImport.onclick;
            cancelImport.onclick = () => {
                closeModal();
                // Restaurar las funciones originales
                confirmImport.onclick = originalConfirmAction;
                cancelImport.onclick = originalCancelAction;
            };
            
            // Cambiar la función del botón cerrar
            const originalCloseAction = closeBtn.onclick;
            closeBtn.onclick = () => {
                closeModal();
                // Restaurar las funciones originales
                confirmImport.onclick = originalConfirmAction;
                cancelImport.onclick = originalCancelAction;
                closeBtn.onclick = originalCloseAction;
            }
        };
        
        saveButton.onclick = async () => {
            if (window.manualSaveToDrive) {
                try {
                    driveResult.textContent = "⏳ Guardando datos...";
                    driveResult.className = "alert alert-info";
                    await window.manualSaveToDrive();
                    driveResult.textContent = "✅ Datos guardados en Google Drive";
                    driveResult.className = "alert alert-success";
                } catch (error) {
                    driveResult.textContent = "❌ Error al guardar: " + error.message;
                    driveResult.className = "alert alert-error";
                }
            }
        };
        
        signoutButton.onclick = async () => {
            if (window.googleDrive && window.googleDrive.signOut) {
                await window.googleDrive.signOut();
                signinButton.style.display = "inline-block";
                loadButton.style.display = "none";
                saveButton.style.display = "none";
                signoutButton.style.display = "none";
                driveResult.textContent = "Desconectado de Google Drive";
                driveResult.className = "alert alert-info";
            }
        };
        
        if (window.googleDrive && window.googleDrive.initialize) {
            window.googleDrive.initialize().then(() => {
                console.log('Google Drive inicializado correctamente');
                if (window.googleDrive.isConnected()) {
                    signinButton.style.display = "none";
                    loadButton.style.display = "inline-block";
                    saveButton.style.display = "inline-block";
                    signoutButton.style.display = "inline-block";
                    driveResult.textContent = "✅ Conectado con Google Drive";
                    driveResult.className = "alert alert-success";
                }
            }).catch(error => {
                console.error('Error al inicializar Google Drive:', error);
                driveResult.textContent = "❌ Error al inicializar Google Drive: " + error.message;
                driveResult.className = "alert alert-error";
           });
        } else {
            console.error('Google Drive no disponible');
            driveResult.textContent = "❌ Google Drive no disponible";
            driveResult.className = "alert alert-error";
        }

        });
    </script>
</body>
</html>
