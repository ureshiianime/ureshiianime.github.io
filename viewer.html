<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ureshii Anime</title>
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="glob/header.css">
    <script src="glob/header.js"></script>
    <link rel="icon" href="img/logo.png" type="image/x-icon">
    <link rel="apple-touch-icon" href="img/logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ureshii Anime">
    <script src="glob/localstorage.js"></script>
    <script src="glob/google-drive.js"></script>
    <script src="animes.js"></script>
    <link rel="stylesheet" href="css/viewer.css">
</head>
<body>
    <header style="height: var(--header-height); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-sizing: border-box;">
        <div class="menu-button" id="menu-toggle">
            <svg class="menu-ab-svg--wDGx3 header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="menu-svg" aria-hidden="true" role="img"><path class="menu-ab-svg__top--Xgjtj" d="M20 5H4V7H20V5Z"></path><path class="menu-ab-svg__middle--vsB5D" d="M4 11H20V13H4V11Z"></path><path class="menu-ab-svg__bottom--6yklx" d="M20 17H4V19H20V17Z"></path></svg>
        </div>
        <a href="index.html" class="header-logo">
            <picture>
                <source media="(max-width: 768px)" srcset="img/logo.png">
                <source media="(min-width: 769px)" srcset="img/horizontal-logo.png">
                <img src="img/horizontal-logo.png" alt="Ureshii Anime" class="logo-img">
            </picture>
        </a>
        <div class="nav-categories">
            <a href="index.html" class="nav-category">Catálogo</a>
            <a href="novedades.html" class="nav-category">Novedades</a>
        </div>
        <div class="header-buttons">
            <a href="search.html" class="header-button">
                <svg class="header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="search-svg" aria-hidden="true" role="img"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.5 19C12.4879 19 14.3164 18.3176 15.7641 17.1742L21.2927 22.7069L22.7074 21.2931L17.1778 15.7595C18.319 14.3126 19 12.4858 19 10.5C19 5.80558 15.1944 2 10.5 2C5.80558 2 2 5.80558 2 10.5C2 15.1944 5.80558 19 10.5 19ZM10.5 17C14.0899 17 17 14.0899 17 10.5C17 6.91015 14.0899 4 10.5 4C6.91015 4 4 6.91015 4 10.5C4 14.0899 6.91015 17 10.5 17Z"></path></svg>
            </a>
            <a href="ureshiilists.html" class="header-button">
                <svg class="header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="watchlist-svg" aria-hidden="true" role="img"><path fill-rule="evenodd" clip-rule="evenodd" d="M19.0001 20.5858C19.0001 21.4767 17.9229 21.9229 17.293 21.2929L12.0001 16L6.7071 21.2929C6.07714 21.9229 5 21.4767 5 20.5858L5.00006 3H19.0001V20.5858ZM7.00001 18.1716L7.00006 5H17.0001V18.1716L12.0001 13.1716L7.00001 18.1716Z"></path></svg>
            </a>
            <a href="account.html" class="export-button" id="export-import-button">
                <svg class="header-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" data-t="user-settings-svg" aria-hidden="true" role="img"><path d="M12 20a6.01 6.01 0 0 1-5.966-5.355L12 12.088l5.966 2.557A6.01 6.01 0 0 1 12 20m0-16c1.654 0 3 1.346 3 3s-1.345 3-2.999 3h-.002A3.003 3.003 0 0 1 9 7c0-1.654 1.346-3 3-3m7.394 9.081l-4.572-1.959A4.997 4.997 0 0 0 17 7c0-2.757-2.243-5-5-5S7 4.243 7 7c0 1.71.865 3.22 2.178 4.122l-4.572 1.959A.999.999 0 0 0 4 14c0 4.411 3.589 8 8 8s8-3.589 8-8c0-.4-.238-.762-.606-.919"></path></svg>
            </a>
        </div>
    </header>
    
    <div class="desktop-mode-notification" id="desktop-notification">
        <p>Para una mejor experiencia y evitar anuncios, activa el modo "Sitio de escritorio" en tu navegador.</p>
        <button class="desktop-mode-button" id="desktop-mode-button">Activar modo escritorio</button>
    </div>

    <div class="viewer-container" id="viewer-container">
        <div class="viewer-background"></div>
        <div class="blue-background"></div>
        <div class="title-badge" id="title-badge">Preparando reproductor...</div>
        
        <div class="loading-overlay" id="loading-overlay">
            <div class="spinner"></div>
            <div class="loading-text">Cargando episodio...</div>
        </div>
        
        <div class="episode-container">
            <h1 class="episode-title" id="episode-title">DAN DA DAN 2 - Temporada 2 - Episodio 8</h1>
            <div class="anime-info" id="anime-info">Preparando reproductor...</div>
            
            <div class="player-container">
                <iframe id="anime-iframe" class="embed-container" allowfullscreen scrolling="yes"></iframe>
            </div>
    
    <div class="anime-info-small" id="anime-info-small">Preparando reproductor...</div>
    
    <div class="toolbar">
        <div class="toolbar-nav">
            <button class="toolbar-button home" id="home-button">Volver</button>
            <button class="toolbar-button" id="next-episode">Episodio Siguiente</button>
        </div>
    </div>

    <script>
        const animeIframe = document.getElementById('anime-iframe');
        const homeButton = document.getElementById('home-button');
        const nextEpisodeButton = document.getElementById('next-episode');
        const loadingOverlay = document.getElementById('loading-overlay');
        const episodeTitle = document.getElementById('episode-title');
        const animeInfo = document.getElementById('anime-info');
        const animeInfoSmall = document.getElementById('anime-info-small');
        const titleBadge = document.getElementById('title-badge');
        
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   (window.innerWidth <= 768);
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        const animeId = urlParams.get('id');
        const seasonNumber = parseInt(urlParams.get('season')) || 1;
        let episodeNumber = parseInt(urlParams.get('episode')) || 1;
        
        window.episodeNumber = episodeNumber;
        
        console.log("[INIT] Parámetros iniciales:", { animeId, seasonNumber, episodeNumber });
        
        const desktopNotification = document.getElementById('desktop-notification');
        const desktopModeButton = document.getElementById('desktop-mode-button');
        
        function enableDesktopMode() {
            try {
                if (document.querySelector('meta[name="viewport"]')) {

                    document.querySelector('meta[name="viewport"]').setAttribute('content', 'width=1024');
                }
                
                if (navigator.standalone !== undefined) {
                    const viewportWidth = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
                    if (viewportWidth < 1024) {
                        window.location.href = 'https://animeflv.net?desktop=1';
                        return;
                    }
                }
                

                desktopNotification.style.display = 'none';
                

                localStorage.setItem('preferDesktopMode', 'true');
                

                window.location.reload();
            } catch (error) {
                console.error('Error al activar modo desktop:', error);

                alert('Por favor, activa manualmente el modo "Sitio de escritorio" en tu navegador.');
            }
        }
        
        function checkMobileAndShowNotification() {
            const preferDesktopMode = localStorage.getItem('preferDesktopMode') === 'true';
            
            if (isMobileDevice() && !preferDesktopMode) {
                desktopNotification.style.display = 'flex';
                
                desktopModeButton.addEventListener('click', enableDesktopMode);
                
                setTimeout(() => {
                    desktopNotification.style.display = 'none';
                }, 15000);
            }
        }
        
        window.addEventListener('DOMContentLoaded', checkMobileAndShowNotification);
        
        function updateParamsFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const newEpisodeNumber = parseInt(urlParams.get('episode')) || 1;
            
            console.log("[INIT] Actualizando parámetros desde URL:", {
                episodeAnterior: window.episodeNumber,
                episodeNuevo: newEpisodeNumber,
                url: window.location.href
            });
            
            episodeNumber = newEpisodeNumber;
            window.episodeNumber = newEpisodeNumber;
            
            return {
                animeId: urlParams.get('id'),
                seasonNumber: parseInt(urlParams.get('season')) || 1,
                episodeNumber: newEpisodeNumber
            };
        }
        
        function getSourceData(){
            if (typeof animeData !== 'undefined' && Array.isArray(animeData)) return animeData;
            if (Array.isArray(window.animeData)) return window.animeData;
            return [];
        }

        function checkAndUnlockEpisodes() {
            const dataArray = getSourceData();
            if (!Array.isArray(dataArray) || dataArray.length === 0) {
                console.warn("Error: animeData no es un array o no está definido");
                return;
            }
            
            const now = new Date();
            const currentDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const currentDateFormatted = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
            
            console.log("Fecha actual del sistema:", currentDateFormatted);
            
            let dataChanged = false;
            
            try {
                dataArray.forEach(anime => {
                    anime.seasons.forEach(season => {
                        if (season.newEpisode) {
                            const originalDate = season.newEpisode.date;
                            

                            const initialDateParts = originalDate.split('-');
                            if (initialDateParts.length === 3) {
                                const initialDate = new Date(Date.UTC(
                                    parseInt(initialDateParts[0]),
                                    parseInt(initialDateParts[1]) - 1,
                                    parseInt(initialDateParts[2])
                                ));
                                
                                const initialDateFormatted = initialDate.toISOString().split('T')[0];
                                
                                const broadcastInterval = season.newEpisode.broadcastInterval || 7;
                                
                                const initialDateObj = new Date(initialDateFormatted);
                                const currentDateObj = new Date(currentDateFormatted);
                                
                                const timeDiff = currentDateObj.getTime() - initialDateObj.getTime();
                                const daysDiff = Math.floor(timeDiff / (1000 * 3600 * 24));
                                
                                let releasedEpisodes = Math.floor(daysDiff / broadcastInterval) + 1;
                                
                                if (releasedEpisodes > season.episodes) {
                                    releasedEpisodes = season.episodes;
                                }
                                
                                if (releasedEpisodes < 0) {
                                    releasedEpisodes = 0;
                                }
                                
                                if (currentDateFormatted < initialDateFormatted) {
                                    releasedEpisodes = 0;
                                }
                                
                                let nextEpisode = releasedEpisodes + 1;
                                
                                if (nextEpisode > season.episodes) {
                                    nextEpisode = null;
                                }
                                
                                let nextReleaseISO = null;
                                let nextReleaseHuman = null;
                                
                                if (nextEpisode !== null) {
                                    const daysToAdd = (nextEpisode - 1) * broadcastInterval;
                                    
                                    const nextReleaseDate = new Date(initialDate);
                                    nextReleaseDate.setUTCDate(initialDate.getUTCDate() + daysToAdd);
                                    
                                    nextReleaseISO = nextReleaseDate.toISOString().split('T')[0];
                                    
                                    const options = { year: 'numeric', month: 'long', day: 'numeric' };
                                    nextReleaseHuman = nextReleaseDate.toLocaleDateString('es-ES', options);
                                }
                                
                                let lastEpisodeReleaseDate = null;
                                if (releasedEpisodes > 0) {
                                    const daysToAdd = (releasedEpisodes - 1) * broadcastInterval;
                                    const lastReleaseDate = new Date(initialDate);
                                    lastReleaseDate.setUTCDate(initialDate.getUTCDate() + daysToAdd);
                                    lastEpisodeReleaseDate = lastReleaseDate.toISOString().split('T')[0];
                                }
                                
                                const isReleasedToday = lastEpisodeReleaseDate === currentDateFormatted;
                                
                                let status;
                                if (releasedEpisodes > 0) {
                                    status = isReleasedToday ? 'Disponible' : 'Próximamente';
                                } else {
                                    status = 'Próximamente';
                                }
                                
                                if (season.newEpisode.releasedEpisodes !== releasedEpisodes ||
                                    season.newEpisode.nextEpisode !== nextEpisode ||
                                    season.newEpisode.status !== status) {
                                    dataChanged = true;
                                }
                                
                                season.newEpisode.releasedEpisodes = releasedEpisodes;
                                season.newEpisode.nextEpisode = nextEpisode;
                                season.newEpisode.status = status;
                                season.newEpisode.isReleasedToday = isReleasedToday;
                                
                                if (nextReleaseISO) {
                                    season.newEpisode.displayDate = nextReleaseISO;
                                    season.newEpisode.displayDateHuman = nextReleaseHuman;
                                } else {
                                    season.newEpisode.displayDate = originalDate;
                                }
                                
                                console.log(`Anime: ${anime.title}, ${season.title}, Ep: ${releasedEpisodes}, Lanzado hoy: ${isReleasedToday}`);
                            }
                        }
                    });
                });
            } catch (error) {
                console.warn("Error al procesar los datos de anime:", error);
            }
        }

        const watchedEpisodes = JSON.parse(localStorage.getItem(WATCHED_EPISODES_KEY)) || {};
        
        checkAndUnlockEpisodes();
        
        const currentAnime = animeData.find(anime => anime.id.toString() === animeId);
        const currentSeason = currentAnime ? currentAnime.seasons.find(season => season.number === seasonNumber) : null;
        
        function markEpisodeAsWatched(animeId, episodeNumber) {
            if (!watchedEpisodes[animeId]) {
                watchedEpisodes[animeId] = [];
            }
            
            if (!watchedEpisodes[animeId].includes(episodeNumber)) {
                watchedEpisodes[animeId].push(episodeNumber);
                localStorage.setItem(WATCHED_EPISODES_KEY, JSON.stringify(watchedEpisodes));
                
                let watchingAnimes = JSON.parse(localStorage.getItem(WATCHING_ANIMES_KEY)) || [];
                
                if (!watchingAnimes.includes(animeId)) {
                    watchingAnimes.push(animeId);
                    localStorage.setItem(WATCHING_ANIMES_KEY, JSON.stringify(watchingAnimes));
                }
            }
        }
        
        function getGlobalEpisodeNumber(anime, seasonNumber, episodeNumber) {
            let globalEpisode = episodeNumber;
            
            for (let i = 0; i < anime.seasons.length; i++) {
                const season = anime.seasons[i];
                if (season.number < seasonNumber) {
                    globalEpisode += season.episodes;
                }
            }
            
            return globalEpisode;
        }
        
        function updateEpisodeInfo() {
            if (currentAnime && currentSeason) {
                const seasonTitle = currentSeason.title || `Temporada ${seasonNumber}`;
                episodeTitle.textContent = `${currentAnime.title.toUpperCase()} - ${seasonTitle} - Episodio ${window.episodeNumber}`;
                animeInfo.textContent = `Reproduciendo: ${currentAnime.title}`;
                animeInfoSmall.textContent = `${currentAnime.title} - ${seasonTitle} - Episodio ${window.episodeNumber}`;
                titleBadge.textContent = `${currentAnime.title} - ${seasonTitle} - Episodio ${window.episodeNumber}`;
            }
        }

        function loadEpisode() {
            if (!currentAnime || !currentSeason) {
                alert('Anime o temporada no encontrados');
                window.location.href = 'index.html';
                return;
            }
            
            loadingOverlay.style.display = 'flex';
            
            const seasonSlug = currentSeason.slug || currentAnime.slug || currentAnime.title.toLowerCase().replace(/\s+/g, '-');
            
            const animeFlvUrl = `https://www3.animeflv.net/ver/${seasonSlug}-${window.episodeNumber}`;
            
            animeIframe.src = animeFlvUrl;
            animeIframe.classList.remove('hidden');
            
            const globalEpisodeNumber = getGlobalEpisodeNumber(currentAnime, seasonNumber, window.episodeNumber);
            markEpisodeAsWatched(currentAnime.id, globalEpisodeNumber);
            
            updateNavigationButtons();
            
            updateEpisodeInfo();
        }
        
        function updateNavigationButtons() {
            const nextEpisodeNumber = window.episodeNumber + 1;
            let shouldDisable = false;
            let hasNextEpisode = false;
            let isNextEpisodeAvailable = false;
            
            if (nextEpisodeNumber <= currentSeason.episodes) {
                hasNextEpisode = true;
                
                if (currentSeason.newEpisode) {
                    const { releasedEpisodes, nextEpisode } = currentSeason.newEpisode;
                    
                    if (nextEpisodeNumber <= releasedEpisodes || 
                        (nextEpisode !== null && nextEpisodeNumber < nextEpisode)) {
                        isNextEpisodeAvailable = true;
                    }
                } else {
                    isNextEpisodeAvailable = true;
                }
            } else {
                const nextSeason = currentAnime.seasons.find(season => season.number === seasonNumber + 1);
                if (nextSeason) {
                    hasNextEpisode = true;
                    
                    if (nextSeason.newEpisode && nextSeason.newEpisode.releasedEpisodes >= 1) {
                        isNextEpisodeAvailable = true;
                    } else if (!nextSeason.newEpisode) {
                        isNextEpisodeAvailable = true;
                    }
                }
            }
            
            if (!hasNextEpisode || !isNextEpisodeAvailable) {
                shouldDisable = true;
            }
            
            nextEpisodeButton.disabled = shouldDisable;
            
            if (shouldDisable) {
                nextEpisodeButton.style.opacity = '0.5';
                nextEpisodeButton.style.cursor = 'not-allowed';
                nextEpisodeButton.style.pointerEvents = 'none';
            } else {
                nextEpisodeButton.style.opacity = '1';
                nextEpisodeButton.style.cursor = 'pointer';
                nextEpisodeButton.style.pointerEvents = 'auto';
            }
        }
        
        function goToPreviousEpisode() {
            if (window.episodeNumber > 1) {
                window.location.href = `viewer.html?id=${animeId}&season=${seasonNumber}&episode=${window.episodeNumber - 1}`;
            } else if (seasonNumber > 1) {
                const prevSeason = currentAnime.seasons.find(season => season.number === seasonNumber - 1);
                if (prevSeason) {
                    window.location.href = `viewer.html?id=${animeId}&season=${seasonNumber - 1}&episode=${prevSeason.episodes}`;
                }
            }
        }
        
        function goToNextEpisode() {
            if (window.episodeNumber < currentSeason.episodes) {
                window.location.href = `viewer.html?id=${animeId}&season=${seasonNumber}&episode=${window.episodeNumber + 1}`;
            } else {
                const nextSeason = currentAnime.seasons.find(season => season.number === seasonNumber + 1);
                if (nextSeason) {
                    window.location.href = `viewer.html?id=${animeId}&season=${seasonNumber + 1}&episode=1`;
                }
            }
        }
        
        function goToHome() {
            if (animeId) {
                window.location.href = `anime.html?id=${animeId}`;
            } else {
                window.location.href = 'index.html';
            }
        }
        
        homeButton.addEventListener('click', () => {
        if (animeId) {
        window.location.href = `anime.html?id=${animeId}`;
        } else {
        window.location.href = 'index.html';
        }
        });
        
        animeIframe.addEventListener('load', () => {
            loadingOverlay.style.display = 'none';
        });
        
        window.addEventListener('popstate', function(event) {
            updateParamsFromURL();
            loadEpisode();
        });
        
        homeButton.addEventListener('click', goToHome);
        nextEpisodeButton.addEventListener('click', goToNextEpisode);
        
        loadEpisode();
    </script>
</body>
</html>